# ============================================================================
# Backend API Deployment Workflow
# ============================================================================
# Purpose: Build API Docker image and push to ECR (triggers ECS update separately)
# Deploys: Python FastAPI application container to Amazon ECR
# Runtime: ECS Fargate (on-demand) - deployed via update-ecs.yml workflow
# ============================================================================

name: Deploy Backend API to ECS

# ============================================================================
# WORKFLOW TRIGGERS
# ============================================================================
on:
  # Trigger when backend or API dockerfile changes
  push:
    branches: [main]
    paths:
      - 'backend/**'                               # Backend Python code changes
      - '!backend/tests/**'                        # Exclude test changes
      - 'Dockerfile.api'                           # API Dockerfile changes
      - '.github/workflows/deploy-backend-api.yml' # Workflow file changes
  
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:

# ============================================================================
# ENVIRONMENT VARIABLES
# ============================================================================
env:
  AWS_REGION: us-east-1                  # AWS region for ECR and ECS
  ECR_REPOSITORY: circle-of-trust-api    # ECR repository name
  ECS_CLUSTER: circle-of-trust-api       # ECS cluster name
  ECS_SERVICE: api-service               # ECS service name
  CONTAINER_NAME: api                    # Container name in task definition

# ============================================================================
# JOBS
# ============================================================================
jobs:
  deploy:
    name: Build and Deploy API
    runs-on: ubuntu-latest  # Run on GitHub-hosted Ubuntu runner
    
    # =========================================================================
    # PERMISSIONS: Required for OIDC authentication with AWS
    # =========================================================================
    permissions:
      id-token: write   # Required to get OIDC token for AWS authentication
      contents: read    # Required to checkout repository code
    
    # =========================================================================
    # DEPLOYMENT STEPS
    # =========================================================================
    steps:
      # -----------------------------------------------------------------------
      # STEP 1: Checkout repository code
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4  # Clone repository to runner
      
      # -----------------------------------------------------------------------
      # STEP 2: Authenticate with AWS using OIDC
      # -----------------------------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Use OIDC to assume IAM role (no long-lived access keys needed)
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
      
      # -----------------------------------------------------------------------
      # STEP 3: Login to Amazon ECR (Elastic Container Registry)
      # -----------------------------------------------------------------------
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        # This action retrieves ECR login credentials and configures Docker CLI
        # Output: Registry URL (e.g., 123456789012.dkr.ecr.us-east-1.amazonaws.com)
      
      # -----------------------------------------------------------------------
      # STEP 4: Generate image tags
      # -----------------------------------------------------------------------
      - name: Set image tag
        id: image
        run: |
          # Use git commit SHA as unique image tag (enables rollback to specific commits)
          echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          # Construct full image repository URL
          echo "repo=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}" >> $GITHUB_OUTPUT
      
      # -----------------------------------------------------------------------
      # STEP 5: Build Docker image for API
      # -----------------------------------------------------------------------
      - name: Build Docker image
        run: |
          # Build image from Dockerfile.api with two tags:
          # 1. SHA tag (e.g., abc123def) - specific version
          # 2. latest tag - always points to most recent build
          docker build \
            -f Dockerfile.api \
            -t ${{ steps.image.outputs.repo }}:${{ steps.image.outputs.tag }} \
            -t ${{ steps.image.outputs.repo }}:latest \
            .
        # Dockerfile.api contains:
        # - Python base image
        # - Install dependencies from pyproject.toml
        # - Copy backend code
        # - Expose port 8000
        # - Run FastAPI with uvicorn
      
      # -----------------------------------------------------------------------
      # STEP 6: Run security vulnerability scan
      # -----------------------------------------------------------------------
      - name: Run security scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.image.outputs.repo }}:${{ steps.image.outputs.tag }}
          format: 'sarif'                   # SARIF format for GitHub Security tab
          output: 'trivy-results.sarif'     # Output file
          severity: 'CRITICAL,HIGH'         # Only report critical/high vulnerabilities
        continue-on-error: true             # Don't fail deployment on vulnerabilities (report only)
      
      # -----------------------------------------------------------------------
      # STEP 7: Push Docker image to ECR
      # -----------------------------------------------------------------------
      - name: Push image to ECR
        run: |
          # Push both tags to ECR
          docker push ${{ steps.image.outputs.repo }}:${{ steps.image.outputs.tag }}  # SHA tag
          docker push ${{ steps.image.outputs.repo }}:latest                          # Latest tag
        # Images are now available in ECR for ECS to pull
      
      # -----------------------------------------------------------------------
      # STEP 8: Display deployment summary
      # -----------------------------------------------------------------------
      - name: Deployment summary
        run: |
          echo "‚úÖ API image pushed to ECR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.image.outputs.repo }}:${{ steps.image.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To deploy this image, run the 'Update ECS Services' workflow" >> $GITHUB_STEP_SUMMARY
      
      # -----------------------------------------------------------------------
      # STEP 9: Trigger ECS service update workflow
      # -----------------------------------------------------------------------
      - name: Trigger ECS update
        uses: actions/github-script@v7
        with:
          script: |
            # Programmatically trigger the update-ecs.yml workflow
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'update-ecs.yml',    # Target workflow file
              ref: 'main',                       # Branch to run on
              inputs: {
                service: 'api'                   # Tell it to update API service only
              }
            })
            console.log('‚úÖ Triggered ECS API service update')
        # This automatically deploys the new image to ECS without manual intervention

      # -----------------------------------------------------------------------
      # STEP 10: Final verification message
      # -----------------------------------------------------------------------
      - name: Verify deployment
        run: |
          echo "‚úÖ API image built and pushed"
          echo "üê≥ Image: ${{ steps.image.outputs.repo }}:${{ steps.image.outputs.tag }}"
          echo "üè∑Ô∏è  Tags: ${{ steps.image.outputs.tag }}, latest"
